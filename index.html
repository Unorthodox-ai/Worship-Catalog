<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wells Salvation - Worship Catalog</title>
  <style>
    :root{--bg:#ffffff;--fg:#111;--muted:#666;--line:#e6e6e6;--accent:#0b57d0;--chip:#f3f4f6;--danger:#b00020;}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;color:var(--fg);background:var(--bg)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 0}
    .brand{display:flex;gap:10px;align-items:center}
    .brand h1{font-size:18px;margin:0;font-weight:650}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 10px;font-size:12px;color:#333}
    .row{display:flex;gap:10px;align-items:center}
    .input, select, textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:9px 10px;outline:none}
    .input:focus, select:focus, textarea:focus{border-color:var(--accent)}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.danger{background:#fff;border-color:var(--danger);color:var(--danger)}
    .tabs{display:flex;gap:6px;border-bottom:1px solid var(--line);margin-top:10px}
    .tab{padding:8px 12px;border:1px solid var(--line);border-bottom:none;border-top-left-radius:10px;border-top-right-radius:10px;background:#fafafa;cursor:pointer}
    .tab.active{background:#fff;border-color:var(--accent);color:var(--accent)}
    .card{border:1px solid var(--line);border-radius:12px;background:#fff}
    .card .head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);color:var(--muted)}
    .grid{display:grid;gap:10px}
    .g-3{grid-template-columns:repeat(3,1fr)}
    .g-4{grid-template-columns:repeat(4,1fr)}
    .g-5{grid-template-columns:repeat(5,1fr)}
    @media (max-width:900px){.g-5,.g-4{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;vertical-align:top;border-top:1px solid var(--line)}
    th{font-weight:600;text-align:left;background:#fafafa}
    .muted{color:var(--muted)}
    .list-row{cursor:pointer}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .hidden{display:none}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);padding:16px}
    .modal.open{display:flex}
    .modal .panel{max-width:750px;width:100%;max-height:90vh;overflow:auto}
    .row-end{display:flex;gap:10px;justify-content:flex-end}
    .settings{border:1px dashed var(--line);border-radius:10px;padding:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <h1>Wells Salvation - Worship Catalog</h1>
        <span id="healthChip" class="chip">Offline</span>
      </div>
      <div class="row" style="gap:6px">
        <input id="apiBase" class="input" placeholder="Paste Apps Script Web App URL (…/exec)" />
        <button class="btn" id="btnTest">Test</button>
      </div>
    </header>

    <section class="settings" style="margin-bottom:10px">
      <div class="grid g-4">
        <input id="adminUser" class="input" placeholder="Admin User (Name or Email in Users sheet)" />
        <input id="adminPin" class="input" placeholder="ADMIN_PIN" />
        <button class="btn" id="btnSaveSettings">Save Settings</button>
        <span class="muted">Saved in your browser only</span>
      </div>
    </section>

    <nav class="tabs">
      <button class="tab active" data-tab="catalog">Catalog</button>
      <button class="tab" data-tab="add">Add Song</button>
      <button class="tab" data-tab="review">Review Queue</button>
    </nav>

    <!-- CATALOG -->
    <section id="view-catalog" class="view" style="margin-top:12px">
      <div class="card">
        <div class="head">Search</div>
        <div class="grid g-5" style="padding:12px">
          <input id="qSong" class="input" placeholder="Song (e.g., Hosanna)" />
          <select id="qTheme"></select>
          <select id="qLanguage"></select>
          <input id="qKey" class="input" placeholder="Key (e.g., G)" />
          <button class="btn primary" id="btnSearch">Search</button>
          <details style="grid-column:1/-1"><summary class="muted">Advanced filters</summary>
            <div class="grid g-3" style="margin-top:8px">
              <input id="qVersionLabel" class="input" placeholder="Version Label" />
              <input id="qVersionArtist" class="input" placeholder="Version Artist" />
              <input id="qArrangement" class="input" placeholder="Arrangement" />
            </div>
          </details>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="head"><span id="resCount" class="muted">0 result(s)</span></div>
        <div style="overflow-x:auto">
          <table id="tblCatalog">
            <thead>
              <tr>
                <th>Song</th>
                <th>Version</th>
                <th>Artist</th>
                <th>Language</th>
                <th>Theme</th>
                <th>Key</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ADD -->
    <section id="view-add" class="view hidden" style="margin-top:12px">
      <div class="card">
        <div class="head">Add Song → Review Queue</div>
        <div class="grid g-3" style="padding:12px">
          <input id="fSong" class="input" placeholder="Song *" />
          <input id="fVersionLabel" class="input" placeholder="Version Label (e.g., Hillsong Live)" />
          <input id="fVersionArtist" class="input" placeholder="Version Artist" />
          <input id="fArrangement" class="input" placeholder="Arrangement (Studio / Live / Hymn)" />
          <select id="fLanguage"></select>
          <select id="fTheme"></select>
          <input id="fKey" class="input" placeholder="Key (e.g., G)" />
          <input id="fKeyM" class="input" placeholder="Typical Key (Male)" />
          <input id="fKeyF" class="input" placeholder="Typical Key (Female)" />
          <input id="fAudio" class="input" placeholder="Audio link (YouTube/Spotify)" />
          <input id="fLyricsLink" class="input" placeholder="Lyrics link" />
          <textarea id="fLyrics" class="input" placeholder="Lyrics (paste or summary)" rows="3"></textarea>
          <textarea id="fNotes" class="input" placeholder="Context notes (tempo, arrangement differences, scripture, etc.)" rows="3"></textarea>
          <input id="fCreatedBy" class="input" placeholder="Your name/email" />
          <div class="row-end" style="grid-column:1/-1">
            <button class="btn" id="btnClear">Clear</button>
            <button class="btn primary" id="btnAdd">Send to Review</button>
          </div>
        </div>
      </div>
    </section>

    <!-- REVIEW -->
    <section id="view-review" class="view hidden" style="margin-top:12px">
      <div class="card">
        <div class="head">
          <span id="revCount" class="muted">0 item(s)</span>
          <div class="row">
            <button class="btn" id="btnRefreshReview">Refresh</button>
            <button class="btn primary" id="btnBulkApprove">Bulk Approve</button>
          </div>
        </div>
        <div style="overflow-x:auto">
          <table id="tblReview">
            <thead>
              <tr>
                <th><input type="checkbox" id="chkAll" /></th>
                <th>Song</th>
                <th>Version</th>
                <th>Artist</th>
                <th>Lang</th>
                <th>Theme</th>
                <th>Key</th>
                <th>Audio</th>
                <th>Lyrics</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Details Modal -->
  <div class="head">
    <span id="mTitle">Song</span>
    <div class="row">
      <button class="btn" id="mEdit">Edit</button>
      <button class="btn primary" id="mSave" style="display:none">Save</button>
      <button class="btn" id="mCancel" style="display:none">Cancel</button>
      <button class="btn" id="mClose">Close</button>
    </div>
  </div>


<script>
(function(){
  const COLS = [
    'SongID','Song','VersionLabel','VersionArtist','Arrangement','Language','Theme','Key',
    'TypicalKeyMale','TypicalKeyFemale','Lyrics','LinkAudio','LinkLyrics','ContextNotes',
    'CreatedAt','CreatedBy','UpdatedAt','UpdatedBy','Slug','Status'
  ];
  const els = {
    tabs: document.querySelectorAll('.tab'),
    views: {
      catalog: document.getElementById('view-catalog'),
      add: document.getElementById('view-add'),
      review: document.getElementById('view-review')
    },
    apiBase: document.getElementById('apiBase'),
    adminUser: document.getElementById('adminUser'),
    adminPin: document.getElementById('adminPin'),
    btnTest: document.getElementById('btnTest'),
    btnSaveSettings: document.getElementById('btnSaveSettings'),
    healthChip: document.getElementById('healthChip'),

    // catalog
    qSong: document.getElementById('qSong'),
    qTheme: document.getElementById('qTheme'),
    qLanguage: document.getElementById('qLanguage'),
    qKey: document.getElementById('qKey'),
    qVersionLabel: document.getElementById('qVersionLabel'),
    qVersionArtist: document.getElementById('qVersionArtist'),
    qArrangement: document.getElementById('qArrangement'),
    btnSearch: document.getElementById('btnSearch'),
    tblCatalog: document.querySelector('#tblCatalog tbody'),
    resCount: document.getElementById('resCount'),

    // add
    fSong: document.getElementById('fSong'),
    fVersionLabel: document.getElementById('fVersionLabel'),
    fVersionArtist: document.getElementById('fVersionArtist'),
    fArrangement: document.getElementById('fArrangement'),
    fLanguage: document.getElementById('fLanguage'),
    fTheme: document.getElementById('fTheme'),
    fKey: document.getElementById('fKey'),
    fKeyM: document.getElementById('fKeyM'),
    fKeyF: document.getElementById('fKeyF'),
    fAudio: document.getElementById('fAudio'),
    fLyricsLink: document.getElementById('fLyricsLink'),
    fLyrics: document.getElementById('fLyrics'),
    fNotes: document.getElementById('fNotes'),
    fCreatedBy: document.getElementById('fCreatedBy'),
    btnAdd: document.getElementById('btnAdd'),
    btnClear: document.getElementById('btnClear'),

    // review
    tblReview: document.querySelector('#tblReview tbody'),
    revCount: document.getElementById('revCount'),
    btnRefreshReview: document.getElementById('btnRefreshReview'),
    btnBulkApprove: document.getElementById('btnBulkApprove'),
    chkAll: document.getElementById('chkAll'),

    // modal
    modal: document.getElementById('modal'),
    mClose: document.getElementById('mClose'),
    mTitle: document.getElementById('mTitle'),
    mVersion: document.getElementById('mVersion'),
    mArtist: document.getElementById('mArtist'),
    mSlug: document.getElementById('mSlug'),
    mLang: document.getElementById('mLang'),
    mTheme: document.getElementById('mTheme'),
    mKeys: document.getElementById('mKeys'),
    mAudio: document.getElementById('mAudio'),
    mLyricsLink: document.getElementById('mLyricsLink'),
    mLyrics: document.getElementById('mLyrics'),
    mNotes: document.getElementById('mNotes'),
  };

  // local storage
  const LS = {
    get(k, d=''){ try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } },
    set(k, v){ try { localStorage.setItem(k, JSON.stringify(v)) } catch{} }
  }
  els.apiBase.value = LS.get('wc_api_base', '');
  els.adminUser.value = LS.get('wc_admin_user', '');
  els.adminPin.value = LS.get('wc_admin_pin', '');

  function setOnline(ok){ els.healthChip.textContent = ok ? 'Online' : 'Offline'; els.healthChip.style.background = ok? '#e8f0fe':'#f3f4f6'; els.healthChip.style.borderColor = ok? '#90c2ff':'#e6e6e6'; els.healthChip.style.color = ok? '#0b57d0':'#333'; }

  async function apiGet(params){
    const base = els.apiBase.value.trim(); if(!/^https?:\/\//.test(base)) throw new Error('Set API URL');
    const qs = new URLSearchParams(params);
    const r = await fetch(`${base}?${qs.toString()}`);
    if(!r.ok) throw new Error(`GET ${params.action} ${r.status}`);
    return r.json();
  }
  async function apiPost(body) {
    const base = document.getElementById('apiBase').value.trim();
    if (!/^https?:\/\//.test(base)) throw new Error('Set API URL');

    // First try JSON (should work when deployment access is correct)
    try {
      const r = await fetch(base, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        redirect: 'follow',
        body: JSON.stringify(body)
      });
      if (!r.ok) throw new Error(`POST ${body.action} ${r.status}`);
      return await r.json();
    } catch (e) {
      // Fallback: send as x-www-form-urlencoded (no JSON headers → fewer preflight issues)
      const params = new URLSearchParams(Object.entries(body).map(([k,v])=>[k, typeof v==='object'? JSON.stringify(v): (v ?? '')]));
      const r2 = await fetch(base, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        redirect: 'follow',
        body: params.toString()
      });
      if (!r2.ok) throw new Error(`POST(Fallback) ${body.action} ${r2.status}`);
      return await r2.json();
    }
  }

  // tabs
  els.tabs.forEach(btn=> btn.addEventListener('click', ()=>{
    els.tabs.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.tab;
    Object.keys(els.views).forEach(k=> els.views[k].classList.toggle('hidden', k!==t));
    if (t==='review') loadReview();
  }));

  // settings
  els.btnSaveSettings.addEventListener('click', ()=>{
    LS.set('wc_api_base', els.apiBase.value.trim());
    LS.set('wc_admin_user', els.adminUser.value.trim());
    LS.set('wc_admin_pin', els.adminPin.value.trim());
    alert('Saved.');
  });
  els.btnTest.addEventListener('click', async()=>{
    try{ const r = await apiGet({action:'health'}); setOnline(true); alert('Backend OK: '+ (r.time||'')); await loadLookups(); }
    catch(e){ setOnline(false); alert(e.message||e); }
  });

  // lookups
  async function loadLookups(){
    try{
      const r = await apiGet({action:'listLookups'});
      fillSelect(els.qTheme, ['','Any'].concat(r.themes||[]));
      fillSelect(els.qLanguage, ['','Any'].concat(r.languages||[]));
      fillSelect(els.fTheme, [''].concat(r.themes||[]));
      fillSelect(els.fLanguage, [''].concat(r.languages||[]));
    }catch(e){ /* ignore */ }
  }
  function fillSelect(sel, arr){ sel.innerHTML=''; arr.forEach((v,i)=>{ const opt=document.createElement('option'); opt.value = i===0? '': v; opt.textContent = v||'--'; sel.appendChild(opt); }); }

  // catalog search
  document.getElementById('btnSearch').addEventListener('click', async()=>{
    try{
      const r = await apiGet({
        action:'searchSongs', song: els.qSong.value, theme: els.qTheme.value, language: els.qLanguage.value, key: els.qKey.value,
        versionlabel: els.qVersionLabel.value, versionartist: els.qVersionArtist.value, arrangement: els.qArrangement.value
      });
      renderCatalog(r.rows||[]);
    }catch(e){ alert(e.message||e); }
  });
  function renderCatalog(rows){
    els.resCount.textContent = `${rows.length} result(s)`;
    const tb = els.tblCatalog; tb.innerHTML='';
    rows.forEach(row=>{
      const tr = document.createElement('tr'); tr.className='list-row';
      tr.innerHTML = `
        <td><div style="font-weight:600">${esc(row.Song)}</div></td>
        <td>${esc(row.VersionLabel||'')}</td>
        <td>${esc(row.VersionArtist||'')}</td>
        <td>${esc(row.Language||'')}</td>
        <td>${esc(row.Theme||'')}</td>
        <td>${esc(row.Key||'')}</td>
        <td class="muted">${esc(row.ContextNotes||'')}</td>
      `;
      tr.addEventListener('click', ()=> openModal(row));
      tb.appendChild(tr);
    });
    if (!rows.length){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="7" class="muted" style="text-align:center;padding:18px">No results</td>`; tb.appendChild(tr); }
  }

  // add song
  els.btnClear.addEventListener('click', ()=> clearForm());
  function clearForm(){ ['fSong','fVersionLabel','fVersionArtist','fArrangement','fLanguage','fTheme','fKey','fKeyM','fKeyF','fAudio','fLyricsLink','fLyrics','fNotes','fCreatedBy'].forEach(id=> els[id].value=''); }
  els.btnAdd.addEventListener('click', async()=>{
    if(!els.fSong.value.trim()) return alert('Song is required');
    try{
      const body = { action:'addToReviewQueue',
        Song: els.fSong.value, VersionLabel: els.fVersionLabel.value, VersionArtist: els.fVersionArtist.value, Arrangement: els.fArrangement.value,
        Language: els.fLanguage.value, Theme: els.fTheme.value, Key: els.fKey.value, TypicalKeyMale: els.fKeyM.value, TypicalKeyFemale: els.fKeyF.value,
        LinkAudio: els.fAudio.value, LinkLyrics: els.fLyricsLink.value, Lyrics: els.fLyrics.value, ContextNotes: els.fNotes.value, CreatedBy: els.fCreatedBy.value
      };
      const r = await apiPost(body);
      alert('Sent to review (row '+ r.rowIndex +')');
      clearForm();
      selectTab('review');
      await loadReview();
    }catch(e){ alert(e.message||e); }
  });

  // review
  els.btnRefreshReview.addEventListener('click', loadReview);
  els.chkAll.addEventListener('change', ()=>{
    const c = els.chkAll.checked; document.querySelectorAll('.rev-chk').forEach(x=> x.checked=c);
  });
  async function loadReview(){
    try{
      const r = await apiGet({action:'listReview'});
      const rows = r.rows||[]; els.revCount.textContent = `${rows.length} item(s)`;
      const tb = els.tblReview; tb.innerHTML='';
      rows.forEach(row=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="rev-chk" data-idx="${row._RowIndex}"/></td>
          <td><div style="font-weight:600">${esc(row.Song)}</div><div class="muted">${esc(row.ContextNotes||'')}</div></td>
          <td>${esc(row.VersionLabel||'')}</td>
          <td>${esc(row.VersionArtist||'')}</td>
          <td>${esc(row.Language||'')}</td>
          <td>${esc(row.Theme||'')}</td>
          <td>${esc(row.Key||'')}</td>
          <td>${row.LinkAudio? `<a href="${esc(row.LinkAudio)}" target="_blank">Open</a>`:''}</td>
          <td>${row.LinkLyrics? `<a href="${esc(row.LinkLyrics)}" target="_blank">Open</a>`:''}</td>
          <td>${esc(row.CreatedAt||'')}</td>
          <td>
            <button class="btn" data-act="approve" data-idx="${row._RowIndex}">Approve</button>
            <button class="btn danger" data-act="reject" data-idx="${row._RowIndex}">Reject</button>
          </td>
        `;
        tb.appendChild(tr);
      });
      if (!rows.length){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="11" class="muted" style="text-align:center;padding:18px">No pending rows</td>`; tb.appendChild(tr); }

      // actions
      tb.querySelectorAll('button[data-act="approve"]').forEach(btn=> btn.addEventListener('click', async()=>{
        const idx = parseInt(btn.dataset.idx,10);
        try{
          const r = await apiPost({ action:'approveReviewRow', rowIndex: idx, adminUser: els.adminUser.value, adminPin: els.adminPin.value });
          alert('Approved → '+ r.slug);
          loadReview();
        }catch(e){ alert(e.message||e); }
      }));
      tb.querySelectorAll('button[data-act="reject"]').forEach(btn=> btn.addEventListener('click', async()=>{
        const idx = parseInt(btn.dataset.idx,10);
        try{
          await apiPost({ action:'rejectReviewRow', rowIndex: idx, adminUser: els.adminUser.value, adminPin: els.adminPin.value });
          loadReview();
        }catch(e){ alert(e.message||e); }
      }));

      // bulk approve
      document.getElementById('btnBulkApprove').onclick = async()=>{
        const rows = Array.from(document.querySelectorAll('.rev-chk:checked')).map(x=> parseInt(x.dataset.idx,10));
        if (!rows.length) return alert('Select at least one');
        try{
          const r = await apiPost({ action:'bulkApprove', rowIndices: rows, adminUser: els.adminUser.value, adminPin: els.adminPin.value });
          alert('Bulk approved: '+ r.results.filter(x=>x.ok).length +'/'+ r.results.length);
          loadReview();
        }catch(e){ alert(e.message||e); }
      };

    }catch(e){ alert(e.message||e); }
  }

  // modal
  function openModal(row){
    els.mTitle.textContent = row.Song || '';
    els.mVersion.textContent = row.VersionLabel || '';
    els.mArtist.textContent = row.VersionArtist || '';
    els.mSlug.textContent = row.Slug || '';
    els.mLang.textContent = row.Language || '';
    els.mTheme.textContent = row.Theme || '';
    els.mKeys.textContent = [row.Key,row.TypicalKeyMale,row.TypicalKeyFemale].filter(Boolean).join(' / ');
    els.mAudio.textContent = row.LinkAudio || ''; els.mAudio.href = row.LinkAudio || '#';
    els.mLyricsLink.textContent = row.LinkLyrics || ''; els.mLyricsLink.href = row.LinkLyrics || '#';
    els.mLyrics.textContent = row.Lyrics || '';
    els.mNotes.textContent = row.ContextNotes || '';
    els.modal.classList.add('open');
  }
  els.mClose.addEventListener('click', ()=> els.modal.classList.remove('open'));
  els.modal.addEventListener('click', (e)=>{ if(e.target===els.modal) els.modal.classList.remove('open'); });

  // helpers
  function esc(s){ return (s==null?'':String(s)).replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
  function selectTab(name){ document.querySelector(`.tab[data-tab="${name}"]`).click(); }

  // initial
  if (els.apiBase.value) { (async()=>{ try{ const r=await apiGet({action:'health'}); setOnline(true); await loadLookups(); } catch{ setOnline(false);} })(); }
})();
</script>
</body>
</html>
