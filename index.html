import React, { useEffect, useMemo, useState } from "react";

/**
 * Worship Catalog Frontend v2 (single-file React)
 * - Works with the Apps Script backend v2 you deployed.
 * - Paste your Web App URL below (or set via the top-right Settings panel).
 * - Features:
 *   • Catalog search (Song/Theme/Language/Key + advanced filters)
 *   • Add Song → Review Queue (pending)
 *   • Review Queue (Admin): approve/reject/bulk approve (needs Admin User + PIN)
 *   • Song details modal (links, notes, keys)
 *
 * Notes:
 * - Data model matches the backend (SongID, Song, VersionLabel, ... Slug, Status)
 * - Lookups (themes/languages/serviceParts) are fetched from backend
 * - Stores API base URL, adminUser, adminPin in localStorage (client-side convenience only)
 */

const DEFAULT_API = ""; // ← Paste Apps Script Web App URL here (ends with /exec)

const COLS = [
  "SongID","Song","VersionLabel","VersionArtist","Arrangement","Language","Theme","Key",
  "TypicalKeyMale","TypicalKeyFemale","Lyrics","LinkAudio","LinkLyrics","ContextNotes",
  "CreatedAt","CreatedBy","UpdatedAt","UpdatedBy","Slug","Status"
];

function useLocalStorage(key, initialValue) {
  const [val, setVal] = useState(() => {
    try {
      const v = localStorage.getItem(key);
      return v !== null ? JSON.parse(v) : initialValue;
    } catch { return initialValue; }
  });
  useEffect(()=>{ try { localStorage.setItem(key, JSON.stringify(val)); } catch {} }, [key,val]);
  return [val, setVal];
}

async function apiGet(base, params) {
  const qs = new URLSearchParams(params);
  const res = await fetch(`${base}?${qs.toString()}`);
  if (!res.ok) throw new Error(`GET ${params.action} failed: ${res.status}`);
  return res.json();
}
async function apiPost(base, body) {
  const res = await fetch(base, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  if (!res.ok) throw new Error(`POST ${body.action} failed: ${res.status}`);
  return res.json();
}

function Badge({ children }) {
  return <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium">{children}</span>
}

function Input({ label, ...props }) {
  return (
    <label className="block">
      {label && <span className="mb-1 block text-xs text-gray-600">{label}</span>}
      <input {...props} className={`w-full rounded-xl border px-3 py-2 outline-none focus:ring ${props.className||''}`} />
    </label>
  );
}
function Select({ label, options, value, onChange, placeholder }){
  return (
    <label className="block">
      {label && <span className="mb-1 block text-xs text-gray-600">{label}</span>}
      <select className="w-full rounded-xl border px-3 py-2" value={value||""} onChange={e=>onChange(e.target.value||"") }>
        <option value="">{placeholder||"--"}</option>
        {options.map(o=> <option key={o} value={o}>{o}</option>)}
      </select>
    </label>
  );
}
function TextArea({ label, ...props }){
  return (
    <label className="block">
      {label && <span className="mb-1 block text-xs text-gray-600">{label}</span>}
      <textarea {...props} className={`w-full rounded-xl border px-3 py-2 outline-none focus:ring ${props.className||''}`}/>
    </label>
  )
}

export default function App(){
  const [apiBase, setApiBase] = useLocalStorage('wc_api_base', DEFAULT_API);
  const [adminUser, setAdminUser] = useLocalStorage('wc_admin_user', "");
  const [adminPin, setAdminPin]   = useLocalStorage('wc_admin_pin', "");

  const [lookups, setLookups] = useState({ themes:[], languages:[], serviceParts:[] });
  const [health, setHealth] = useState(null);

  const [tab, setTab] = useState('catalog'); // 'catalog' | 'add' | 'review'

  // Catalog/search state
  const [qSong, setQSong] = useState("");
  const [qTheme, setQTheme] = useState("");
  const [qLanguage, setQLanguage] = useState("");
  const [qKey, setQKey] = useState("");
  const [qAdvOpen, setQAdvOpen] = useState(false);
  const [qVersionLabel, setQVersionLabel] = useState("");
  const [qVersionArtist, setQVersionArtist] = useState("");
  const [qArrangement, setQArrangement] = useState("");
  const [catalog, setCatalog] = useState([]);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");
  const [selected, setSelected] = useState(null);

  // Add Song form
  const [form, setForm] = useState({
    Song:"", VersionLabel:"", VersionArtist:"", Arrangement:"",
    Language:"", Theme:"", Key:"", TypicalKeyMale:"", TypicalKeyFemale:"",
    LinkAudio:"", LinkLyrics:"", Lyrics:"", ContextNotes:"", CreatedBy:""
  });
  const formDisabled = !form.Song;

  // Review Queue
  const [review, setReview] = useState([]);
  const [reviewLoading, setReviewLoading] = useState(false);
  const [bulkSel, setBulkSel] = useState({});

  const canCall = useMemo(()=> apiBase && /^https?:\/\//.test(apiBase), [apiBase]);

  async function refreshHealth(){
    setErr("");
    if (!canCall) return;
    try{
      const r = await apiGet(apiBase, { action:'health' });
      setHealth(r);
    } catch(e){ setErr(String(e.message||e)); }
  }
  async function refreshLookups(){
    setErr("");
    if (!canCall) return;
    try {
      const r = await apiGet(apiBase, { action:'listLookups' });
      setLookups(r);
    } catch(e){ setErr(String(e.message||e)); }
  }
  async function search(){
    setErr(""); setLoading(true);
    try{
      const r = await apiGet(apiBase, {
        action:'searchSongs',
        song:qSong, theme:qTheme, language:qLanguage, key:qKey,
        versionlabel:qVersionLabel, versionartist:qVersionArtist, arrangement:qArrangement
      });
      setCatalog(r.rows||[]);
    }catch(e){ setErr(String(e.message||e)); }
    finally{ setLoading(false); }
  }
  async function loadReview(){
    setErr(""); setReviewLoading(true);
    try{
      const r = await apiGet(apiBase, { action:'listReview' });
      setReview(r.rows||[]);
      setBulkSel({});
    }catch(e){ setErr(String(e.message||e)); }
    finally{ setReviewLoading(false); }
  }

  async function addToReview(){
    if (!canCall) return alert('Set API base first');
    try{
      const body = { action:'addToReviewQueue', ...form };
      const r = await apiPost(apiBase, body);
      alert(`Sent to review (row ${r.rowIndex}).`);
      setForm({
        Song:"", VersionLabel:"", VersionArtist:"", Arrangement:"",
        Language:"", Theme:"", Key:"", TypicalKeyMale:"", TypicalKeyFemale:"",
        LinkAudio:"", LinkLyrics:"", Lyrics:"", ContextNotes:"", CreatedBy:""
      });
      setTab('review');
      loadReview();
    }catch(e){ alert(String(e.message||e)); }
  }

  async function approveRow(rowIndex){
    if (!adminUser || !adminPin) return alert('Set Admin User & PIN in Settings');
    try{
      const r = await apiPost(apiBase, { action:'approveReviewRow', rowIndex, adminUser, adminPin });
      await loadReview();
      alert(`Approved → ${r.slug}`);
    }catch(e){ alert(String(e.message||e)); }
  }
  async function rejectRow(rowIndex){
    if (!adminUser || !adminPin) return alert('Set Admin User & PIN in Settings');
    try{
      await apiPost(apiBase, { action:'rejectReviewRow', rowIndex, adminUser, adminPin });
      await loadReview();
    }catch(e){ alert(String(e.message||e)); }
  }
  async function bulkApprove(){
    const rows = Object.keys(bulkSel).filter(k=>bulkSel[k]).map(k=>parseInt(k,10));
    if (!rows.length) return alert('Select at least one');
    if (!adminUser || !adminPin) return alert('Set Admin User & PIN in Settings');
    try{
      const r = await apiPost(apiBase, { action:'bulkApprove', rowIndices: rows, adminUser, adminPin });
      await loadReview();
      alert(`Bulk approved: ${r.results.filter(x=>x.ok).length}/${r.results.length}`);
    }catch(e){ alert(String(e.message||e)); }
  }

  useEffect(()=>{ if (canCall){ refreshHealth(); refreshLookups(); } }, [canCall]);

  const topBar = (
    <div className="flex items-center justify-between gap-3">
      <div className="flex items-center gap-2">
        <span className="text-lg font-semibold">Worship Catalog</span>
        {health?.ok && <Badge>Online</Badge>}
      </div>
      <div className="flex items-center gap-2">
        <Input placeholder="https://script.google.com/.../exec" value={apiBase} onChange={e=>setApiBase(e.target.value)} />
        <details className="ml-2">
          <summary className="cursor-pointer select-none rounded-xl border px-3 py-2 text-sm">Settings</summary>
          <div className="mt-2 grid gap-2 rounded-xl border p-3">
            <Input label="Admin User (must match Users sheet Name or Email)" value={adminUser} onChange={e=>setAdminUser(e.target.value)} />
            <Input label="Admin PIN (Config → ADMIN_PIN)" value={adminPin} onChange={e=>setAdminPin(e.target.value)} />
            <button className="rounded-xl bg-black px-3 py-2 text-white" onClick={()=>{refreshHealth(); refreshLookups();}}>Test Connection</button>
          </div>
        </details>
      </div>
    </div>
  );

  return (
    <div className="mx-auto max-w-6xl p-4 font-sans">
      {topBar}
      <div className="mt-4 flex gap-2">
        <button onClick={()=>setTab('catalog')} className={`rounded-xl px-3 py-2 ${tab==='catalog'?'bg-black text-white':'border'}`}>Catalog</button>
        <button onClick={()=>setTab('add')} className={`rounded-xl px-3 py-2 ${tab==='add'?'bg-black text-white':'border'}`}>Add Song</button>
        <button onClick={()=>{setTab('review'); loadReview();}} className={`rounded-xl px-3 py-2 ${tab==='review'?'bg-black text-white':'border'}`}>Review Queue</button>
      </div>

      {err && <div className="mt-3 rounded-xl border border-red-300 bg-red-50 p-2 text-sm text-red-800">{String(err)}</div>}

      {tab==='catalog' && (
        <section className="mt-4 space-y-3">
          <div className="grid grid-cols-1 gap-3 md:grid-cols-5">
            <Input label="Song" placeholder="e.g., Hosanna" value={qSong} onChange={e=>setQSong(e.target.value)} />
            <Select label="Theme" options={lookups.themes} value={qTheme} onChange={setQTheme} placeholder="Any" />
            <Select label="Language" options={lookups.languages} value={qLanguage} onChange={setQLanguage} placeholder="Any" />
            <Input label="Key" placeholder="e.g., G" value={qKey} onChange={e=>setQKey(e.target.value)} />
            <div className="flex items-end">
              <button onClick={search} className="w-full rounded-xl bg-black px-3 py-2 text-white">Search</button>
            </div>
          </div>
          <button className="text-sm underline" onClick={()=>setQAdvOpen(s=>!s)}>{qAdvOpen? 'Hide':'Show'} advanced filters</button>
          {qAdvOpen && (
            <div className="grid grid-cols-1 gap-3 md:grid-cols-3">
              <Input label="Version Label" value={qVersionLabel} onChange={e=>setQVersionLabel(e.target.value)} />
              <Input label="Version Artist" value={qVersionArtist} onChange={e=>setQVersionArtist(e.target.value)} />
              <Input label="Arrangement" value={qArrangement} onChange={e=>setQArrangement(e.target.value)} />
            </div>
          )}

          <div className="mt-3 rounded-2xl border">
            <div className="flex items-center justify-between border-b p-3 text-sm text-gray-600">
              <span>{loading? 'Loading…' : `${catalog.length} result(s)`}</span>
            </div>
            <div className="divide-y">
              {catalog.map((row)=> (
                <div key={(row.SongID||row.Slug||Math.random())} className="grid cursor-pointer grid-cols-1 gap-2 p-3 hover:bg-gray-50 md:grid-cols-6" onClick={()=>setSelected(row)}>
                  <div className="md:col-span-2">
                    <div className="font-medium">{row.Song}</div>
                    <div className="mt-1 flex flex-wrap gap-1 text-xs text-gray-600">
                      {row.VersionLabel && <Badge>{row.VersionLabel}</Badge>}
                      {row.Language && <Badge>{row.Language}</Badge>}
                      {row.Key && <Badge>Key {row.Key}</Badge>}
                    </div>
                  </div>
                  <div className="text-sm text-gray-700">{row.Theme}</div>
                  <div className="truncate text-sm text-gray-700">{row.VersionArtist}</div>
                  <div className="truncate text-sm text-gray-700">{row.Arrangement}</div>
                  <div className="truncate text-xs text-gray-500">{row.ContextNotes}</div>
                </div>
              ))}
              {!catalog.length && !loading && (
                <div className="p-6 text-center text-sm text-gray-500">No results yet. Try a search.</div>
              )}
            </div>
          </div>
        </section>
      )}

      {tab==='add' && (
        <section className="mt-4 grid gap-3">
          <div className="grid grid-cols-1 gap-3 md:grid-cols-3">
            <Input label="Song *" value={form.Song} onChange={e=>setForm(f=>({...f, Song:e.target.value}))} />
            <Input label="Version Label" placeholder="e.g., Hillsong United (World Edition)" value={form.VersionLabel} onChange={e=>setForm(f=>({...f, VersionLabel:e.target.value}))} />
            <Input label="Version Artist" value={form.VersionArtist} onChange={e=>setForm(f=>({...f, VersionArtist:e.target.value}))} />
            <Input label="Arrangement" placeholder="Studio / Live / Hymn / Chorus" value={form.Arrangement} onChange={e=>setForm(f=>({...f, Arrangement:e.target.value}))} />
            <Select label="Language" options={lookups.languages} value={form.Language} onChange={v=>setForm(f=>({...f, Language:v}))} placeholder="Type or select" />
            <Select label="Theme" options={lookups.themes} value={form.Theme} onChange={v=>setForm(f=>({...f, Theme:v}))} placeholder="Type or select" />
            <Input label="Key" placeholder="e.g., G, E, Bb" value={form.Key} onChange={e=>setForm(f=>({...f, Key:e.target.value}))} />
            <Input label="Typical Key (Male)" value={form.TypicalKeyMale} onChange={e=>setForm(f=>({...f, TypicalKeyMale:e.target.value}))} />
            <Input label="Typical Key (Female)" value={form.TypicalKeyFemale} onChange={e=>setForm(f=>({...f, TypicalKeyFemale:e.target.value}))} />
          </div>
          <div className="grid grid-cols-1 gap-3 md:grid-cols-2">
            <Input label="Audio Link (YouTube/Spotify)" value={form.LinkAudio} onChange={e=>setForm(f=>({...f, LinkAudio:e.target.value}))} />
            <Input label="Lyrics Link" value={form.LinkLyrics} onChange={e=>setForm(f=>({...f, LinkLyrics:e.target.value}))} />
          </div>
          <TextArea label="Lyrics (paste or summary)" rows={4} value={form.Lyrics} onChange={e=>setForm(f=>({...f, Lyrics:e.target.value}))} />
          <TextArea label="Context Notes (tempo, arrangement differences, etc.)" rows={3} value={form.ContextNotes} onChange={e=>setForm(f=>({...f, ContextNotes:e.target.value}))} />
          <div className="grid grid-cols-1 gap-3 md:grid-cols-3">
            <Input label="Created By" placeholder="Your name/email" value={form.CreatedBy} onChange={e=>setForm(f=>({...f, CreatedBy:e.target.value}))} />
          </div>
          <div className="flex justify-end gap-2">
            <button className="rounded-xl border px-3 py-2" onClick={()=>setForm({Song:"",VersionLabel:"",VersionArtist:"",Arrangement:"",Language:"",Theme:"",Key:"",TypicalKeyMale:"",TypicalKeyFemale:"",LinkAudio:"",LinkLyrics:"",Lyrics:"",ContextNotes:"",CreatedBy:""})}>Clear</button>
            <button disabled={formDisabled} className={`rounded-xl px-3 py-2 ${formDisabled? 'bg-gray-300 text-gray-600':'bg-black text-white'}`} onClick={addToReview}>Send to Review</button>
          </div>
        </section>
      )}

      {tab==='review' && (
        <section className="mt-4">
          <div className="mb-3 flex items-center justify-between">
            <div className="text-sm text-gray-600">{reviewLoading? 'Loading…' : `${review.length} item(s)`}</div>
            <div className="flex gap-2">
              <button className="rounded-xl border px-3 py-2" onClick={loadReview}>Refresh</button>
              <button className="rounded-xl bg-black px-3 py-2 text-white" onClick={bulkApprove}>Bulk Approve</button>
            </div>
          </div>
          <div className="overflow-auto rounded-2xl border">
            <table className="min-w-full text-sm">
              <thead className="bg-gray-50 text-left">
                <tr>
                  <th className="p-2"><input type="checkbox" onChange={e=>{
                    const v = e.target.checked; const m={}; review.forEach(r=> m[r._RowIndex]=v); setBulkSel(m);
                  }}/></th>
                  <th className="p-2">Song</th>
                  <th className="p-2">Version</th>
                  <th className="p-2">Artist</th>
                  <th className="p-2">Lang</th>
                  <th className="p-2">Theme</th>
                  <th className="p-2">Key</th>
                  <th className="p-2">Audio</th>
                  <th className="p-2">Lyrics</th>
                  <th className="p-2">Created</th>
                  <th className="p-2">Actions</th>
                </tr>
              </thead>
              <tbody>
                {review.map(r=> (
                  <tr key={r._RowIndex} className="border-t">
                    <td className="p-2 align-top"><input type="checkbox" checked={!!bulkSel[r._RowIndex]} onChange={e=> setBulkSel(s=>({...s, [r._RowIndex]: e.target.checked})) }/></td>
                    <td className="p-2 align-top">
                      <div className="font-medium">{r.Song}</div>
                      <div className="text-xs text-gray-500">{r.ContextNotes}</div>
                    </td>
                    <td className="p-2 align-top">{r.VersionLabel}</td>
                    <td className="p-2 align-top">{r.VersionArtist}</td>
                    <td className="p-2 align-top">{r.Language}</td>
                    <td className="p-2 align-top">{r.Theme}</td>
                    <td className="p-2 align-top">{r.Key}</td>
                    <td className="p-2 align-top">{r.LinkAudio? <a className="text-blue-600 underline" href={r.LinkAudio} target="_blank" rel="noreferrer">Open</a>: ''}</td>
                    <td className="p-2 align-top">{r.LinkLyrics? <a className="text-blue-600 underline" href={r.LinkLyrics} target="_blank" rel="noreferrer">Open</a>: ''}</td>
                    <td className="p-2 align-top">{r.CreatedAt}</td>
                    <td className="p-2 align-top">
                      <div className="flex gap-2">
                        <button className="rounded-xl border px-2 py-1" onClick={()=>approveRow(r._RowIndex)}>Approve</button>
                        <button className="rounded-xl border px-2 py-1" onClick={()=>rejectRow(r._RowIndex)}>Reject</button>
                      </div>
                    </td>
                  </tr>
                ))}
                {!review.length && !reviewLoading && (
                  <tr><td colSpan={11} className="p-6 text-center text-gray-500">No pending rows.</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      )}

      {/* Song details modal */}
      {selected && (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/40 p-4" onClick={()=>setSelected(null)}>
          <div className="max-h-[90vh] w-full max-w-2xl overflow-auto rounded-2xl bg-white p-4" onClick={e=>e.stopPropagation()}>
            <div className="mb-2 flex items-start justify-between">
              <div>
                <div className="text-xl font-semibold">{selected.Song}</div>
                <div className="mt-1 flex flex-wrap gap-1 text-xs text-gray-600">
                  {selected.VersionLabel && <Badge>{selected.VersionLabel}</Badge>}
                  {selected.VersionArtist && <Badge>{selected.VersionArtist}</Badge>}
                  {selected.Language && <Badge>{selected.Language}</Badge>}
                  {selected.Theme && <Badge>{selected.Theme}</Badge>}
                  {selected.Key && <Badge>Key {selected.Key}</Badge>}
                </div>
              </div>
              <button className="rounded-full border px-3 py-1" onClick={()=>setSelected(null)}>Close</button>
            </div>
            <div className="grid gap-3">
              <div className="grid grid-cols-1 gap-3 md:grid-cols-2">
                <Input label="Audio Link" readOnly value={selected.LinkAudio||''} />
                <Input label="Lyrics Link" readOnly value={selected.LinkLyrics||''} />
              </div>
              <div className="grid grid-cols-1 gap-3 md:grid-cols-3">
                <Input label="Typical Key (Male)" readOnly value={selected.TypicalKeyMale||''} />
                <Input label="Typical Key (Female)" readOnly value={selected.TypicalKeyFemale||''} />
                <Input label="Slug" readOnly value={selected.Slug||''} />
              </div>
              {selected.Lyrics && <TextArea label="Lyrics" readOnly rows={8} value={selected.Lyrics}/>}            
              {selected.ContextNotes && <TextArea label="Context Notes" readOnly rows={4} value={selected.ContextNotes}/>}            
              <div className="grid grid-cols-1 gap-3 md:grid-cols-2 text-xs text-gray-500">
                <Input label="Created At" readOnly value={selected.CreatedAt||''} />
                <Input label="Created By" readOnly value={selected.CreatedBy||''} />
                <Input label="Updated At" readOnly value={selected.UpdatedAt||''} />
                <Input label="Updated By" readOnly value={selected.UpdatedBy||''} />
              </div>
            </div>
          </div>
        </div>
      )}

      <footer className="mt-8 text-center text-xs text-gray-500">v2 frontend • paste your API URL above • data persists in your Google Sheet</footer>
    </div>
  );
}
